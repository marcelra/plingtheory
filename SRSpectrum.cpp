#include "SRSpectrum.h"

namespace WaveAnalysis
{

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// constructor
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
SRSpectrum::SRSpectrum( const FourierSpectrum& ft, const FourierSpectrum& ftDerivative, const FourierSpectrum& ftTimeRamp ) :
   FourierSpectrum( ft ),
   m_correctedFrequencies( getConfig().getSpectrumDimension() ),
   m_freqCorrections( getConfig().getSpectrumDimension() ),
   m_timeCorrections( getConfig().getSpectrumDimension() )
{
   assert( getConfig() == ft.getConfig() );

   for ( size_t i = 0; i < ft.size(); ++i )
   {
      double normInv = 1. / norm( ft[i] );
      m_freqCorrections[i] = normInv * ( ftDerivative[i] * conj( ft[i] ) ).imag() * ft.getConfig().getSamplingInfo().getSamplingRate() / 2. / M_PI;
      m_timeCorrections[i] = normInv * ( ftTimeRamp[i] * conj( ft[i] ) ).real();
      m_correctedFrequencies[i] = getConfig().getSpectrumFrequencies()[i] + m_freqCorrections[i];
   }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// getFrequencyOfBin
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
double SRSpectrum::getFrequencyOfBin( size_t binIndex ) const
{
   return m_correctedFrequencies[ binIndex ];
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// getFrequencies
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
const RealVector& SRSpectrum::getFrequencies() const
{
   return m_correctedFrequencies;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// getFrequency
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
double SRSpectrum::getFrequency( double x ) const
{
   size_t indexLeft = floor( x );
   size_t indexRight = ceil( x );
   double diff = m_correctedFrequencies[ indexRight ] - m_correctedFrequencies[ indexLeft ];
   return m_correctedFrequencies[ indexLeft ] + ( x - indexLeft ) * diff;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// getFrequencyCorrections
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
const RealVector& SRSpectrum::getFrequencyCorrections() const
{
   return m_freqCorrections;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// getTimeCorrections
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
const RealVector& SRSpectrum::getTimeCorrections() const
{
   return m_timeCorrections;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// rebinToFourierLattice
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Math::RegularAccumArray SRSpectrum::rebinToFourierLattice() const
{
   size_t nBins = getFrequencies().size();
   double freqBinWidth = FourierSpectrum::getFrequencies()[1] - FourierSpectrum::getFrequencies()[0];
   double minX = FourierSpectrum::getFrequencies()[0] - 0.5 * freqBinWidth;
   double maxX = FourierSpectrum::getFrequencies()[ nBins - 1 ] - 0.5 * freqBinWidth;

   Math::RegularAccumArray result( nBins, minX, maxX );

   for ( size_t i = 0; i < nBins; ++i )
   {
      result.add( getFrequencies()[i], getMagnitudeInBin( i ) );
   }
   return result;
}

} /// namespace WaveAnalysis
