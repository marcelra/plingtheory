#include "IThread.h"

#include "Logger.h"

/// boost includes
#include <boost/chrono.hpp>
#include <boost/thread.hpp>

/// STL includes
#include <cassert>
#include <stdint.h>

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// constructor
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
IThread::IThread( const std::string& threadName ) :
   m_isFinished( false ),
   m_isKilled( false ),
   m_isRunning( false ),
   m_returnStatus( Pending ),
   m_pollTimeMilliSeconds( 1 ),
   m_logger( new Logger( threadName ) )
{}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// destructor
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
IThread::~IThread()
{
   delete m_logger;
   if ( hasStarted() )
   {
      if ( !isKilled() )
      {
         assert( isFinished() );
         assert( m_thread != 0 );
         delete m_thread;
      }
   }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// getLogger
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
Logger& IThread::getLogger()
{
   return *m_logger;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// start
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void IThread::start()
{
   assert( !hasStarted() );
   m_isRunning = true;
   m_thread = new boost::thread( IThread::runWrapper, this );
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// runWrapper
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void IThread::runWrapper( IThread* instance )
{
   instance->m_returnStatus = instance->run();
   assert( instance->m_returnStatus != Pending );
   instance->m_isRunning = false;
   instance->m_isFinished = true;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// join
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void IThread::join()
{
   getLogger() << Msg::Verbose << "In IThread::join..." << Msg::EndReq;
   size_t nPolls = 0;
   while ( !isFinished() )
   {
      ++nPolls;
      waitNextPoll();
   }
   getLogger() << Msg::Verbose << "Needed " << nPolls << " poll" << (nPolls != 1 ? "s" : "") <<
                  " of " << m_pollTimeMilliSeconds << " milliseconds before thread was finished." << Msg::EndReq;
   getLogger() << Msg::Verbose << "Leaving IThread::join." << Msg::EndReq;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// waitNextPoll
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void IThread::waitNextPoll()
{
   boost::this_thread::sleep_for( boost::chrono::milliseconds( m_pollTimeMilliSeconds ) );
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// run
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
IThread::ReturnStatus IThread::run()
{
   for ( size_t i = 0; i < 10000; ++i )
   {
      getLogger() << Msg::Verbose << "i = " << i << ": cos( i ) = " << cos( i ) << Msg::EndReq;
   }
   return Finished;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// kill
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void IThread::kill()
{
   getLogger() << Msg::Verbose << "Killing thread with id " << m_thread->get_id() << Msg::EndReq;
   m_thread->interrupt();
   m_thread->join();

   delete m_thread;
   m_thread = 0;
   m_isRunning = false;
   m_isKilled = true;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// getReturnStatus
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
IThread::ReturnStatus IThread::getReturnStatus() const
{
   return m_returnStatus;
}
